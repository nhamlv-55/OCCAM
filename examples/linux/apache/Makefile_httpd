#iam 7/13/2018

THISDIR =  $(shell pwd)
OS      =  $(shell uname)
ARCH    =  $(shell uname -p)

LLVMCC ?= gclang
LLVMCXX ?= gclang++
LLVMGET ?= get-bc

ifeq (Darwin, $(findstring Darwin, ${OS}))
LIBEXT=dylib
else
LIBEXT=so
endif


PCRE_VERSION=8.42
APR_VERSION=1.6.3
APR_UTIL_VERSION=1.6.1


PCRE_INSTALL=${THISDIR}/install/pcre-${PCRE_VERSION}
APR_INSTALL=${THISDIR}/install/apr-${APR_VERSION}
APR_UTIL_INSTALL=${THISDIR}/install/apr-util-${APR_UTIL_VERSION}


HTTPD_VERSION=2.4.33
HTTPD=httpd-${HTTPD_VERSION}
HTTPD_TARBALL=${HTTPD}.tar.gz
HTTPD_URL=http://apache.cs.utah.edu/httpd/${HTTPD_TARBALL}
HTTPD_EXE=httpd
HTTPD_BITCODE=${HTTPD_EXE}.bc
HTTPD_INSTALL=${THISDIR}/install/${HTTPD}



all: ${HTTPD_BITCODE}

${HTTPD_TARBALL}:
	wget ${HTTPD_URL}

${HTTPD}: ${HTTPD_TARBALL}
	tar xvf ${HTTPD}.tar

Makefile_pcre:
	$(error Makefile_pcre is missing but required)

${PCRE_INSTALL}: Makefile_pcre
	make -C . -f Makefile_pcre

Makefile_apr:
	$(error Makefile_apr is missing but required)

${APR_INSTALL}: Makefile_apr
	make -C . -f Makefile_apr

Makefile_apr_util:
	$(error Makefile_apr_util is missing but required)

${APR_UTIL_INSTALL}: Makefile_apr_util
	make -C . -f Makefile_apr_util


${HTTPD_INSTALL}: ${PCRE_INSTALL} ${APR_INSTALL} ${APR_UTIL_INSTALL} ${HTTPD}
	mkdir -p ${HTTPD}_build                                                           && \
	cd  ${HTTPD}_build                                                                && \
	CC=${LLVMCC} ../${HTTPD}/configure --prefix=${HTTPD_INSTALL}                         \
                                       --with-pcre=${PCRE_INSTALL}/bin/pcre-config           \
                                       --with-apr=${APR_INSTALL}                             \
				       --with-apr-util=${APR_UTIL_INSTALL}                && \
	CC=${LLVMCC} make                                                                 && \
	${LLVMGET} httpd                                                                  && \
	cp httpd.bc ../                                                                   && \
	make install


${HTTPD_BITCODE}: ${HTTPD_INSTALL}
	cd ${HTTPD_INSTALL}/bin                                             && \
	${LLVMGET} httpd                                                    && \
	cp ${HTTPD_BITCODE} ${THISDIR}/${HTTPD_BITCODE}


clean:
	rm -rf *~  ${HTTPD_BITCODE}


very_clean: clean
	rm -rf ${HTTPD_INSTALL}
	make -C ${HTTPD} clean
	make -C . -f Makefile_pcre very_clean
	make -C . -f Makefile_apr very_clean
	make -C . -f Makefile_apr_util very_clean

spotless: very_clean 
	rm -rf ${HTTPD_TARBALL} ${HTTPD} 
	make -C . -f Makefile_pcre spotless
	make -C . -f Makefile_apr spotless
	make -C . -f Makefile_apr_util spotless
