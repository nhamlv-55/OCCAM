#iam 7/13/2018

THISDIR =  $(shell pwd)
OS      =  $(shell uname)
ARCH    =  $(shell uname -p)

LLVMCC ?= gclang
LLVMCXX ?= gclang++
LLVMGET ?= get-bc

ifeq (Darwin, $(findstring Darwin, ${OS}))
LIBEXT=dylib
else
LIBEXT=so
endif



APR_VERSION ?= 1.6.3

APR=apr-${APR_VERSION}
APR_TARBALL=${APR}.tar.gz
APR_URL=http://apache.mirrors.ionfish.org/apr/${APR_TARBALL}
APR_LIB=libapr-1.${LIBEXT}
APR_BITCODE=${APR_LIB}.bc
APR_INSTALL=${THISDIR}/install/${APR}

all: ${APR_BITCODE}

${APR_TARBALL}:
	wget ${APR_URL}

${APR}: ${APR_TARBALL}
	tar xvfz ${APR_TARBALL}

${APR_INSTALL}/lib/libapr-1.so: ${APR}
	cd ${APR}                                                    && \
	CC=${LLVMCC} ./configure --prefix=${APR_INSTALL}             && \
	CC=${LLVMCC} make                                            && \
	make install

${APR_BITCODE}: ${APR_INSTALL}/lib/libapr-1.so
	cd ${APR_INSTALL}/lib                                        && \
	${LLVMGET} libapr-1.so                                       && \
	cp libapr-1.so.*.bc ${THISDIR}/libapr-1.so.bc

clean:
	rm -rf *~  ${APR_BITCODE}


very_clean: clean
	rm -rf ${APR} ${APR_INSTALL}

spotless: very_clean
	rm -rf ${APR_TARBALL}
